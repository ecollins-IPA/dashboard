---
params:
    set_title: "x"
    set_subtitle: "y"
    set_author: "a"
title: "`r params$set_title`"
subtitle: "`r params$set_subtitle`"
author: "`r params$author`"
output: 
  html_document
---


```{r, include=FALSE, echo = FALSE}

knitr::opts_chunk$set(echo = FALSE)

library(DT)
library(dplyr)
library(openxlsx)
library(knitr)
library("xlsx")
library(geosphere)
library(readstata13)
library(rgdal)
library(tidyverse)
library(skimr)
library(ggplot2)
library(broom)
library(mapproj)
library(magrittr)
library(maptools)
```


```{r, warning = FALSE, message = FALSE, echo = FALSE}
# CHECKS
if(!exists("my_data")) stop("my_data missing")
if(!exists("my_vars")) stop("my_vars missing")
if(!exists("my_text")) stop("my_text missing")

if(!all(c("date", "id") %in% names(my_data))) stop("my_data should include date and id variables")

my_data <- mutate(my_data, date = as.Date(date))
```

`r my_text$intro_text`^[`r my_text$intro_note`]

---

```{r, warning = FALSE, message = FALSE, echo = FALSE}
families   <- my_vars %>% pull(family) %>% unique
n_families <- length(families)
k          <- 1
vars_used  <- my_vars %>% filter(!is.na(variable)) %>% pull(variable)
vars_used  <-c("start", "district", vars_used)


# Prep maps

shp <- readOGR( 
  dsn= my_maps, 
  layer="SLE_adm3",
  verbose=FALSE,
   stringsAsFactors = F
) 

shp_df <- broom::tidy(shp, region = "NAME_2")

```


#   {.tabset .tabset-pills}

```{r, child = childRmd, echo = FALSE, eval = k>0}

```


## All Data  {.tabset  .tabset-pills}

`r my_text$data_note`

### Browse data  {.tabset}

```{r, echo = FALSE, message = FALSE, warning = FALSE}

my_data %>%
 group_by(id, date) %>% mutate(obs = n()) %>% ungroup %>%
 group_by(id, date)  %>%
 summarise_all( function(x)  mean(x, na.rm = T)) %>% 
 mutate_if(is.numeric, ~round(., 3)) %>%
  datatable(caption = paste('Data to date, village level'), 
          rownames = TRUE, 
          extensions = c('Buttons', 'Scroller', 'ColReorder', 'FixedColumns'), 
          options = list(colreorder = TRUE, 
                         dom = 'Bfrtip',
                         buttons = c('copy', 'csv', 'excel'),
                         deferRender = TRUE,
                         scrollY = 200,
                         scroller = TRUE,
                         scrollX = TRUE
#,
#          fixedColumns = list(leftColumns = 1)
  )) 
```

### Data summaries  {.tabset}

**Technical**: Summary measures on all data.

```{r, warning = FALSE, echo = FALSE}
skimr::skim(my_data)
```

# 

---

Notes
